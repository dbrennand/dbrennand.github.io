<!doctype html><html lang=en-us><head><title>Using Caddy v2's reverse proxy feature with a domain managed with Cloudflare! | Daniel Brennand</title><meta charset=utf-8><meta name=language content="en"><meta name=description content="How to use Caddy v2 as a reverse proxy with a Cloudflare managed domain."><meta name=keywords content><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><link rel="shortcut icon" type=image/png href=/favicon.ico><link type=text/css rel=stylesheet href=/css/post.min.2cb93c91050d1853bf971cc31e00122edd6e0f405aa1de3b7f8ef67ea3b5a79a.css integrity="sha256-LLk8kQUNGFO/lxzDHgASLt1uD0Baod47f472fqO1p5o="><link type=text/css rel=stylesheet href=/css/custom.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css integrity="sha256-47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU="><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/danielbrennand.com\/"},"articleSection":"blog","name":"Using Caddy v2\u0027s reverse proxy feature with a domain managed with Cloudflare!","headline":"Using Caddy v2\u0027s reverse proxy feature with a domain managed with Cloudflare!","description":"How to use Caddy v2 as a reverse proxy with a Cloudflare managed domain.","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2020","datePublished":"2020-07-21 21:08:07 \u002b0100 \u002b0100","dateModified":"2020-07-21 21:08:07 \u002b0100 \u002b0100","url":"https:\/\/danielbrennand.com\/blog\/caddy-cloudflare\/","wordCount":"818","keywords":["Blog"]}</script></head><body><div class=burger__container><div class=burger aria-controls=navigation aria-label=Menu><div class="burger__meat burger__meat--1"></div><div class="burger__meat burger__meat--2"></div><div class="burger__meat burger__meat--3"></div></div></div><nav class=nav id=navigation><ul class=nav__list><li><a href=/>About</a></li><li><a href=/blog>Blog</a></li></ul></nav><main><div class=flex-wrapper><div class=post__container><div class=post><header class=post__header><h1 id=post__title>Using Caddy v2's reverse proxy feature with a domain managed with Cloudflare!</h1><time datetime="2020-07-21 21:08:07 +0100 +0100" class=post__date>Jul 21 2020</time></header><article class=post__content><p><a href=https://caddyserver.com/>Caddy</a> version <a href=https://github.com/caddyserver/caddy/releases/tag/v2.0.0>2.0.0</a> released on May 4th 2020. Caddy brands itself as &ldquo;The Ultimate Server&rdquo; with <a href=https://caddyserver.com/docs/>functionality</a> including a web server, reverse proxy, automatic certificate renewal, automatic HTTPS and more!</p><p>I have to say, it&rsquo;s pretty awesome! üëç</p><p>This blog post will show you how to use the Caddy v2 reverse proxy feature with a domain managed with Cloudflare. So, lets jump in! üòÑ</p><h2 id=caddyfile>Caddyfile<a class=anchor href=#caddyfile>#</a></h2><p>Caddy uses a <a href=https://caddyserver.com/docs/caddyfile>Caddyfile</a> for it&rsquo;s configuration.</p><p>Two main Caddyfile concepts to understand are <a href=https://caddyserver.com/docs/caddyfile/concepts#blocks><strong>blocks</strong></a> and <a href=https://caddyserver.com/docs/caddyfile/concepts#directives><strong>directives</strong></a>.</p><h3 id=blocks>Blocks<a class=anchor href=#blocks>#</a></h3><p>A Caddyfile block contains configuration for a site. Blocks are declared using curly braces:</p><pre><code>example.com {
    ...
}
</code></pre><p>One unique block worth mentioning is the <a href=https://caddyserver.com/docs/caddyfile/options>global options block</a>. This block <strong>must</strong> be defined at the top of the Caddyfile and allows you to modify options which apply globally to Caddy. Two usage examples for this block are altering the <strong>acme_ca</strong> (ACME CA&rsquo;s directory) to the <a href=https://letsencrypt.org/docs/staging-environment/>Let&rsquo;s Encrypt staging endpoint</a> or the <strong>email</strong> option which is used when creating the ACME account.</p><p>To use the global options block along with a site block, your Caddyfile would look similar to the following:</p><pre><code class=language-caddyfile>{
    email example@example.com
    # This is a valid comment in a Caddyfile :-)
    # This acme_ca option tells Caddy to use the Let's Encrypt staging endpoint
    # Remove when transitioning to a production environment
    acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}
# Site block below
example.com {
    ...
}
</code></pre><h3 id=directives-and-subdirectives>Directives and Subdirectives<a class=anchor href=#directives-and-subdirectives>#</a></h3><p>Caddyfile directives customise how a site is served by Caddy and <strong>must</strong> be declared within a site block. A subdirective provides additional configuration for a directive. See the Caddy <a href=https://caddyserver.com/docs/caddyfile/directives>documentation</a> for a full list of directives and their respective subdirectives.</p><p>The directive we are interested in this blog post is the <a href=https://caddyserver.com/docs/caddyfile/directives/reverse_proxy>reverse_proxy</a> directive.</p><p>Adding to the previous example, usage of the reverse_proxy directive is as follows:</p><pre><code class=language-caddyfile>{
    email example@example.com
    # This acme_ca option tells Caddy to use the Let's Encrypt staging endpoint
    # Remove when transitioning to a production environment
    acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}
# Site block below
example.com {
    # Using the reverse_proxy directive within a site block
    reverse_proxy example:80
}
</code></pre><h2 id=using-the-caddy-v2-docker-container-with-a-cloudflare-managed-domain>Using the Caddy v2 Docker container with a Cloudflare managed domain<a class=anchor href=#using-the-caddy-v2-docker-container-with-a-cloudflare-managed-domain>#</a></h2><p>Right, enough of the boring theory! Onto an actual example.</p><p>I have created a <a href=https://github.com/dbrennand/caddy-cloudflare-docker-compose>Github repository</a> which uses docker-compose to deploy the Caddy v2 container (including the <a href=https://github.com/caddy-dns/cloudflare>Cloudflare module</a>) and <a href=https://www.freshrss.org/>freshrss</a> as an example application.</p><p>We will be using the <a href=https://caddyserver.com/docs/automatic-https#dns-challenge>DNS-01 challenge</a> type to request a certificate for the subdomain <code>freshrss</code> under your Cloudflare managed apex domain.</p><h3 id=prerequisites>Prerequisites<a class=anchor href=#prerequisites>#</a></h3><ol><li><p>A domain managed with Cloudflare</p></li><li><p><strong>SSL/TLS encryption mode</strong> set the <strong>Full (strict)</strong></p><ul><li>This ensures that clients don&rsquo;t encounter <a href=https://caddy.community/t/infinite-redirection/3230/5>infinite redirects</a>, they connect via HTTPS and ensures the Let&rsquo;s Encrypt certificate on the server is valid.</li></ul></li><li><p>A server with ports 80 and 443 accessible to the internet</p><ul><li><strong>NOTE</strong>: The DNS-01 challenge type doesn&rsquo;t require any open ports however, in order to access any applications from the internet, we need these ports exposed.</li></ul></li><li><p>A server with Docker, docker-compose and git installed</p></li><li><p>An A record configured in Cloudflare with the following values:</p><ul><li><p><strong>Type</strong>: A</p></li><li><p><strong>Name</strong>: freshrss</p></li><li><p><strong>Content</strong>: The IPv4 address of your server</p></li><li><p><strong>TTL</strong>: Auto</p></li><li><p><strong>Proxy Status</strong>: Proxied</p></li></ul></li><li><p>A <a href=https://github.com/libdns/cloudflare#authenticating>Cloudflare API token</a> (<strong>NOT</strong> an API key!) with the following permissions:</p><ul><li><p>Zone / Zone / Read</p></li><li><p>Zone / DNS / Edit</p></li></ul></li></ol><h3 id=deployment>Deployment<a class=anchor href=#deployment>#</a></h3><ol><li><p>Clone the caddy-cloudflare-docker-compose repository and change directory: <code>git clone https://github.com/dbrennand/caddy-cloudflare-docker-compose.git; cd caddy-cloudflare-docker-compose</code>.</p></li><li><p>Make a copy of the ExampleCaddyfile called Caddyfile: <code>cp ExampleCaddyfile Caddyfile</code>.</p></li><li><p>Modify the following lines in the Caddyfile:</p><ul><li><p><code>email example@example.com</code>: Alter <code>example@example.com</code> to your email address.</p></li><li><p><code>subdomain.example.com</code>: Modify this to be your domain. For example: <code>freshrss.yourdomain.com</code>.</p></li></ul></li></ol><p><strong>NOTE</strong>: I have provided some snippets and comments in the ExampleCaddyfile which I hope you will find useful.</p><ol start=4><li>Modify the <code>CLOUDFLARE_API_TOKEN</code> environment variable in the docker-compose.yaml file with your Cloudflare API token:</li></ol><pre><code class=language-dockerfile>environment:
      CLOUDFLARE_API_TOKEN: &quot;Insert your Cloudflare API token here.&quot;
</code></pre><ol start=5><li><p>Modify the <code>PUID</code>, <code>PGID</code> and <code>TZ</code> environment variables in the docker-compose.yaml file (if required).</p></li><li><p>Start the Caddy and freshrss containers using: <code>docker-compose up -d</code>.</p></li></ol><p>View the Caddy container logs using: <code>docker logs caddy</code>. If everything is configured correctly, you will see something similar to the following output in the Caddy container logs:</p><pre><code>[INFO] [freshrss.yourdomain.com] acme: use dns-01 solver
[INFO] [freshrss.yourdomain.com] acme: Preparing to solve DNS-01
[INFO] [freshrss.yourdomain.com] acme: Trying to solve DNS-01
[INFO] [freshrss.yourdomain.com] acme: Checking DNS record propagation using [127.0.0.11:53]
[INFO] Wait for propagation [timeout: 1m0s, interval: 2s]
[INFO] [freshrss.yourdomain.com] acme: Waiting for DNS record propagation.
[INFO] [freshrss.yourdomain.com] The server validated our request
[INFO] [freshrss.yourdomain.com] acme: Cleaning DNS-01 challenge
[INFO] [freshrss.yourdomain.com] acme: Validations succeeded; requesting certificates
[INFO] [freshrss.yourdomain.com] Server responded with a certificate.
[INFO][freshrss.yourdomain.com] Certificate obtained successfully
[INFO][freshrss.yourdomain.com] Obtain: Releasing lock
</code></pre><p>‚≠ê Congratulations! You have successfully configured Caddy to obtain a valid certificate from Let&rsquo;s Encrypt for the subdomain <code>freshrss</code> under your Cloudflare apex domain üòÑ</p><p>Navigate to <code>freshrss.yourdomain.com</code> in your browser and you will see the setup wizard for freshrss!</p><p>In my next blog post, I will cover how you can use Cloudflare as a Dynamic DNS (DDNS) provider.</p></article><ul class=tags__list><li class=tag__item><a class=tag__link href=https://danielbrennand.com/tags/caddy/>caddy</a></li><li class=tag__item><a class=tag__link href=https://danielbrennand.com/tags/reverse-proxy/>reverse-proxy</a></li><li class=tag__item><a class=tag__link href=https://danielbrennand.com/tags/cloudflare/>cloudflare</a></li><li class=tag__item><a class=tag__link href=https://danielbrennand.com/tags/docker/>docker</a></li><li class=tag__item><a class=tag__link href=https://danielbrennand.com/tags/containers/>containers</a></li></ul><div class=pagination><a class=pagination__item href=https://danielbrennand.com/blog/cloudflare-ddns/><span class=pagination__label>Next Post</span>
<span class=pagination__title>Using Cloudflare as a Dynamic DNS (DDNS) provider</a></a></div><footer class=post__footer><div class=social-icons><a class=social-icons__link title=GitHub href=https://github.com/dbrennand target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://danielbrennand.com/svg/github.svg)></div></a><a class=social-icons__link title=Email href=mailto:contact@danielbrennand.com target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://danielbrennand.com/svg/email.svg)></div></a><a class=social-icons__link title=LinkedIn href=https://www.linkedin.com/in/daniel-brennand/ target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://danielbrennand.com/svg/linkedin.svg)></div></a></div><p>¬© 2020</p></footer></div></div></div></main><script src=/js/index.min.49e4d8a384357d9b445b87371863419937ede9fa77737522ffb633073aebfa44.js integrity="sha256-SeTYo4Q1fZtEW4c3GGNBmTft6fp3c3Ui/7YzBzrr+kQ=" crossorigin=anonymous></script><script src=https://unpkg.com/prismjs@1.20.0/components/prism-core.min.js></script><script src=https://unpkg.com/prismjs@1.20.0/plugins/autoloader/prism-autoloader.min.js data-autoloader-path=https://unpkg.com/prismjs@1.20.0/components/></script></body></html>