<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Testing Ansible Content with Molecule | Daniel Brennand</title><meta name=keywords content="Ansible,Testing,Molecule"><meta name=description content="Time for another blog post! üöÄ
In this blog post, I will be discussing how to test Ansible content with Molecule üß™
What is Molecule?  Molecule aids in the development and testing of Ansible content: collections, playbooks and roles.
github.com/ansible-community/molecule1 Why do we need to test Ansible content? Testing is an integral part of the software development lifecycle. It helps identify and prevent bugs from reaching production and in some cases, helps identify performance issues."><meta name=author content="Daniel Brennand"><link rel=canonical href=https://danielbrennand.com/blog/testing-ansible-content/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.b9961d1ced22696fb5927ae69a4d78d0b4a3bdb2414abf2c56d54dc2432e0484.js integrity="sha256-uZYdHO0iaW+1knrmmk140LSjvbJBSr8sVtVNwkMuBIQ=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://danielbrennand.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://danielbrennand.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://danielbrennand.com/favicon-32x32.png><link rel=apple-touch-icon href=https://danielbrennand.com/apple-touch-icon.png><link rel=mask-icon href=https://danielbrennand.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Testing Ansible Content with Molecule"><meta property="og:description" content="Time for another blog post! üöÄ
In this blog post, I will be discussing how to test Ansible content with Molecule üß™
What is Molecule?  Molecule aids in the development and testing of Ansible content: collections, playbooks and roles.
github.com/ansible-community/molecule1 Why do we need to test Ansible content? Testing is an integral part of the software development lifecycle. It helps identify and prevent bugs from reaching production and in some cases, helps identify performance issues."><meta property="og:type" content="article"><meta property="og:url" content="https://danielbrennand.com/blog/testing-ansible-content/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-07-30T16:14:50+01:00"><meta property="article:modified_time" content="2023-07-30T16:14:50+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Testing Ansible Content with Molecule"><meta name=twitter:description content="Time for another blog post! üöÄ
In this blog post, I will be discussing how to test Ansible content with Molecule üß™
What is Molecule?  Molecule aids in the development and testing of Ansible content: collections, playbooks and roles.
github.com/ansible-community/molecule1 Why do we need to test Ansible content? Testing is an integral part of the software development lifecycle. It helps identify and prevent bugs from reaching production and in some cases, helps identify performance issues."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Blogs","item":"https://danielbrennand.com/blog/"},{"@type":"ListItem","position":3,"name":"Testing Ansible Content with Molecule","item":"https://danielbrennand.com/blog/testing-ansible-content/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Testing Ansible Content with Molecule","name":"Testing Ansible Content with Molecule","description":"Time for another blog post! üöÄ\nIn this blog post, I will be discussing how to test Ansible content with Molecule üß™\nWhat is Molecule?  Molecule aids in the development and testing of Ansible content: collections, playbooks and roles.\ngithub.com/ansible-community/molecule1 Why do we need to test Ansible content? Testing is an integral part of the software development lifecycle. It helps identify and prevent bugs from reaching production and in some cases, helps identify performance issues.","keywords":["Ansible","Testing","Molecule"],"articleBody":"Time for another blog post! üöÄ\nIn this blog post, I will be discussing how to test Ansible content with Molecule üß™\nWhat is Molecule?  Molecule aids in the development and testing of Ansible content: collections, playbooks and roles.\ngithub.com/ansible-community/molecule1 Why do we need to test Ansible content? Testing is an integral part of the software development lifecycle. It helps identify and prevent bugs from reaching production and in some cases, helps identify performance issues. When creating Ansible content we need to ensure that it works as expected and that we are not introducing any undesired behaviour. This is where Molecule comes in.\nMolecule Terminology üìö Molecule has several terms that are used throughout the documentation. Let‚Äôs go over them now.\nInstances \u0026 Drivers üöó Molecule instances are what your Ansible content is executed against. Instances are created using a driver. Molecule has several drivers for handling the creation and destruction of instances. The drivers are currently located in ansible-community/molecule-plugins repository.\nFor example, the default Docker driver can be used to create a container instance and the Vagrant driver can create a virtual machine instance.\nScenarios üìñ Molecule scenarios can be thought of as a test suite. Each scenario contains its own instances and configuration. For example, a scenario could be used to test an Ansible role against different distributions or test a specific configuration of a role.\nThere should always be a default scenario which is used to test Ansible content with its default configuration.\nMolecule Directory Structure üìÅ A basic Molecule directory structure is:\nmolecule ‚îî‚îÄ‚îÄ default ‚îú‚îÄ‚îÄ prepare.yml ‚îú‚îÄ‚îÄ converge.yml ‚îú‚îÄ‚îÄ verify.yml ‚îî‚îÄ‚îÄ molecule.yml Within the molecule directory is the default scenario directory which contains the prepare.yml, converge.yml and verify.yml playbooks, as well as the molecule.yml configuration file.\nPrepare Playbook ‚ñ∂Ô∏è The prepare.yml playbook defines the preparation tasks to run before the converge.yml playbook. For example, this could be used configure the instance.\nConverge Playbook ‚ñ∂Ô∏è The converge.yml playbook defines the Ansible content to be tested. This can be a playbook, role or collection.\nVerify Playbook ‚ñ∂Ô∏è The verify.yml playbook is executed after the converge.yml playbook. This playbook contains verification tasks to check the Ansible content has been applied correctly.\nConfiguration File molecule.yml üìù The molecule.yml file contains configuration for each Molecule component2:\n   Component Description     Dependency Manager Molecule uses Ansible Galaxy as the default manager for resolving role and collection dependencies.   Driver Instances \u0026 Drivers.   Platforms (Instances) Defines instances to be created by the driver for the scenario.   Provisioner Molecule uses Ansible as the provisioner. The provisioner manages the life cycle of instances by communicating with the driver.   Scenario Molecule‚Äôs default scenario configuration can be overridden for full control over each sequence.   Verifier Molecule uses Ansible as the verifier. The verifier uses the verify.yml playbook to check the state of the instance.    The example below shows a basic configuration using the Docker driver to create a Debian container instance.\n--- dependency: name: galaxy driver: name: docker platforms: - name: instance image: geerlingguy/docker-debian10-ansible:latest pre_build_image: true provisioner: name: ansible verifier: name: ansible Molecule Commands üìú Molecule has several commands for performing different actions. The most common commands are:\n   Molecule Command Description     create Creates the instance defined in the molecule.yml file.   destroy Destroys the instance defined in the molecule.yml file.   login Spawns a shell inside the instance. Useful for troubleshooting.   converge Performs the converge sequence which includes creating the instance and executing the prepare.yml and converge.yml playbooks.   test Performs a full test scenario. This includes the converge and idempotency sequences, executing the verify.yml playbook and destroying the instance.    Now that we have covered the basics, let‚Äôs test an Ansible playbook with Molecule! üß™\nDemo üì∫ I‚Äôve created a demo repository which contains a simple playbook to install nginx on a Debian container instance. You‚Äôll need to have Docker and Python installed to use the repository.\nBegin by cloning the repository:\ngit clone https://github.com/dbrennand/molecule-demo.git \u0026\u0026 cd molecule-demo Inspect the files and notice the default molecule scenario with the playbooks and molecule.yml configuration file. The converge.yml playbook calls the main playbook.yml two directories above.\nNext, install Molecule and the Docker driver. I recommend using a virtual environment:\nmkdir -pv ~/.virtualenvs python3 -m venv ~/.virtualenvs/molecule-demo source ~/.virtualenvs/molecule-demo/bin/activate pip install -r requirements.txt Now we can run the molecule test command to perform a full test scenario:\nmolecule test The output should look similar to the following:\nINFO Running default  create PLAY [Create] ****************************************************************** TASK [Create molecule instance(s)] ********************************************* changed: [localhost] = (item=instance) ... INFO Running default  prepare PLAY [Prepare] ***************************************************************** TASK [Gathering Facts] ********************************************************* ok: [instance] TASK [Update apt cache] ******************************************************** changed: [instance] ... INFO Running default  converge PLAY [Converge] **************************************************************** TASK [Gathering Facts] ********************************************************* ok: [instance] PLAY [Playbook | Install nginx] ************************************************ TASK [Gathering Facts] ********************************************************* ok: [instance] TASK [Install nginx] *********************************************************** changed: [instance] PLAY RECAP ********************************************************************* instance : ok=3 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 INFO Running default  idempotence PLAY [Converge] **************************************************************** TASK [Gathering Facts] ********************************************************* ok: [instance] PLAY [Playbook | Install nginx] ************************************************ TASK [Gathering Facts] ********************************************************* ok: [instance] TASK [Install nginx] *********************************************************** ok: [instance] PLAY RECAP ********************************************************************* instance : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 INFO Idempotence completed successfully. INFO Running default  side_effect WARNING Skipping, side effect playbook not configured. INFO Running default  verify INFO Running Ansible Verifier PLAY [Verify] ****************************************************************** TASK [Gathering Facts] ********************************************************* ok: [instance] TASK [Gather package list] ***************************************************** ok: [instance] TASK [Verify nginx is installed] *********************************************** ok: [instance] = { \"changed\": false, \"msg\": \"All assertions passed\" } PLAY RECAP ********************************************************************* instance : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 INFO Verifier completed successfully. INFO Running default  cleanup WARNING Skipping, cleanup playbook not configured. INFO Running default  destroy PLAY [Destroy] ***************************************************************** TASK [Wait for instance(s) deletion to complete] ******************************* FAILED - RETRYING: [localhost]: Wait for instance(s) deletion to complete (300 retries left). changed: [localhost] = (item=instance) PLAY RECAP ********************************************************************* localhost : ok=3 changed=2 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 Tada! You‚Äôve just tested an Ansible playbook with Molecule! ‚ú®üéâ\nWe now have peace of mind that our playbook works as expected! üôÇ\nConclusion üìù In this blog post, we covered the basics of using Molecule and how to test Ansible content. I recommend checking out the Molecule documentation for more information.\nI hope you found this post useful and if you have any questions or feedback, feel free to reach out to me on Twitter or via email.\nUntil next time, happy testing! üß™ üëã\nReferences   https://github.com/ansible-community/molecule¬†‚Ü©Ô∏é\n https://ansible.readthedocs.io/projects/molecule/getting-started/#the-scenario-layout¬†‚Ü©Ô∏é\n   ","wordCount":"1069","inLanguage":"en","datePublished":"2023-07-30T16:14:50+01:00","dateModified":"2023-07-30T16:14:50+01:00","author":{"@type":"Person","name":"Daniel Brennand"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://danielbrennand.com/blog/testing-ansible-content/"},"publisher":{"@type":"Organization","name":"Daniel Brennand","logo":{"@type":"ImageObject","url":"https://danielbrennand.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://danielbrennand.com accesskey=h title="Daniel Brennand (Alt + H)">Daniel Brennand</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://danielbrennand.com/blog title=Blog><span>Blog</span></a></li><li><a href=https://danielbrennand.com/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://danielbrennand.com/tags title=Tags><span>Tags</span></a></li><li><a href=https://danielbrennand.com/archives title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://danielbrennand.com>Home</a>&nbsp;¬ª&nbsp;<a href=https://danielbrennand.com/blog/>Blogs</a></div><h1 class=post-title>Testing Ansible Content with Molecule</h1><div class=post-meta><span title="2023-07-30 16:14:50 +0100 +0100">July 30, 2023</span>&nbsp;¬∑&nbsp;6 min&nbsp;¬∑&nbsp;Daniel Brennand</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#what-is-molecule aria-label="What is Molecule?">What is Molecule?</a></li><li><a href=#why-do-we-need-to-test-ansible-content aria-label="Why do we need to test Ansible content?">Why do we need to test Ansible content?</a></li><li><a href=#molecule-terminology- aria-label="Molecule Terminology üìö">Molecule Terminology üìö</a></li><li><a href=#instances--drivers- aria-label="Instances &amp;amp; Drivers üöó">Instances & Drivers üöó</a></li><li><a href=#scenarios- aria-label="Scenarios üìñ">Scenarios üìñ</a></li><li><a href=#molecule-directory-structure- aria-label="Molecule Directory Structure üìÅ">Molecule Directory Structure üìÅ</a><ul><li><a href=#prepare-playbook- aria-label="Prepare Playbook ‚ñ∂Ô∏è">Prepare Playbook ‚ñ∂Ô∏è</a></li><li><a href=#converge-playbook- aria-label="Converge Playbook ‚ñ∂Ô∏è">Converge Playbook ‚ñ∂Ô∏è</a></li><li><a href=#verify-playbook- aria-label="Verify Playbook ‚ñ∂Ô∏è">Verify Playbook ‚ñ∂Ô∏è</a></li><li><a href=#configuration-file-moleculeyml- aria-label="Configuration File molecule.yml üìù">Configuration File <code>molecule.yml</code> üìù</a></li><li><a href=#molecule-commands- aria-label="Molecule Commands üìú">Molecule Commands üìú</a></li></ul></li><li><a href=#demo- aria-label="Demo üì∫">Demo üì∫</a></li><li><a href=#conclusion- aria-label="Conclusion üìù">Conclusion üìù</a></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>Time for another blog post! üöÄ</p><p>In this blog post, I will be discussing how to test Ansible content with <a href=https://github.com/ansible-community/molecule>Molecule</a> üß™</p><h2 id=what-is-molecule>What is Molecule?<a hidden class=anchor aria-hidden=true href=#what-is-molecule>#</a></h2><blockquote><p>Molecule aids in the development and testing of Ansible content: collections, playbooks and roles.</p><p>github.com/ansible-community/molecule<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p></blockquote><h2 id=why-do-we-need-to-test-ansible-content>Why do we need to test Ansible content?<a hidden class=anchor aria-hidden=true href=#why-do-we-need-to-test-ansible-content>#</a></h2><p>Testing is an integral part of the software development lifecycle. It helps identify and prevent bugs from reaching production and in some cases, helps identify performance issues. When creating Ansible content we need to ensure that it works as expected and that we are not introducing any undesired behaviour. This is where Molecule comes in.</p><h2 id=molecule-terminology->Molecule Terminology üìö<a hidden class=anchor aria-hidden=true href=#molecule-terminology->#</a></h2><p>Molecule has several terms that are used throughout the documentation. Let&rsquo;s go over them now.</p><h2 id=instances--drivers->Instances & Drivers üöó<a hidden class=anchor aria-hidden=true href=#instances--drivers->#</a></h2><p>Molecule instances are what your Ansible content is executed against. Instances are created using a driver. Molecule has several drivers for handling the creation and destruction of instances. The drivers are currently located in <a href=https://github.com/ansible-community/molecule-plugins>ansible-community/molecule-plugins</a> repository.</p><p>For example, the default <a href=https://github.com/ansible-community/molecule-plugins/blob/main/src/molecule_plugins/docker/driver.py>Docker driver</a> can be used to create a container instance and the <a href=https://github.com/ansible-community/molecule-plugins/blob/main/src/molecule_plugins/vagrant/driver.py>Vagrant driver</a> can create a virtual machine instance.</p><h2 id=scenarios->Scenarios üìñ<a hidden class=anchor aria-hidden=true href=#scenarios->#</a></h2><p>Molecule scenarios can be thought of as a test suite. Each scenario contains its own instances and configuration. For example, a scenario could be used to test an Ansible role against different distributions or test a specific configuration of a role.</p><p>There should always be a <code>default</code> scenario which is used to test Ansible content with its default configuration.</p><h2 id=molecule-directory-structure->Molecule Directory Structure üìÅ<a hidden class=anchor aria-hidden=true href=#molecule-directory-structure->#</a></h2><p>A basic Molecule directory structure is:</p><pre><code>molecule
‚îî‚îÄ‚îÄ default
    ‚îú‚îÄ‚îÄ prepare.yml
    ‚îú‚îÄ‚îÄ converge.yml
    ‚îú‚îÄ‚îÄ verify.yml
    ‚îî‚îÄ‚îÄ molecule.yml
</code></pre><p>Within the <code>molecule</code> directory is the <code>default</code> scenario directory which contains the <code>prepare.yml</code>, <code>converge.yml</code> and <code>verify.yml</code> playbooks, as well as the <code>molecule.yml</code> configuration file.</p><h3 id=prepare-playbook->Prepare Playbook ‚ñ∂Ô∏è<a hidden class=anchor aria-hidden=true href=#prepare-playbook->#</a></h3><p>The <code>prepare.yml</code> playbook defines the preparation tasks to run before the <code>converge.yml</code> playbook. For example, this could be used configure the instance.</p><h3 id=converge-playbook->Converge Playbook ‚ñ∂Ô∏è<a hidden class=anchor aria-hidden=true href=#converge-playbook->#</a></h3><p>The <code>converge.yml</code> playbook defines the Ansible content to be tested. This can be a playbook, role or collection.</p><h3 id=verify-playbook->Verify Playbook ‚ñ∂Ô∏è<a hidden class=anchor aria-hidden=true href=#verify-playbook->#</a></h3><p>The <code>verify.yml</code> playbook is executed after the <code>converge.yml</code> playbook. This playbook contains verification tasks to check the Ansible content has been applied correctly.</p><h3 id=configuration-file-moleculeyml->Configuration File <code>molecule.yml</code> üìù<a hidden class=anchor aria-hidden=true href=#configuration-file-moleculeyml->#</a></h3><p>The <code>molecule.yml</code> file contains configuration for each Molecule component<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>:</p><table><thead><tr><th>Component</th><th>Description</th></tr></thead><tbody><tr><td><a href=https://ansible.readthedocs.io/projects/molecule/configuration/#dependency>Dependency Manager</a></td><td>Molecule uses <a href=https://galaxy.ansible.com/>Ansible Galaxy</a> as the default manager for resolving role and collection dependencies.</td></tr><tr><td><a href=https://ansible.readthedocs.io/projects/molecule/configuration/#driver>Driver</a></td><td><a href=#instances--drivers->Instances & Drivers</a>.</td></tr><tr><td><a href=https://ansible.readthedocs.io/projects/molecule/configuration/#platforms>Platforms (Instances)</a></td><td>Defines instances to be created by the driver for the scenario.</td></tr><tr><td><a href=https://ansible.readthedocs.io/projects/molecule/configuration/#provisioner>Provisioner</a></td><td>Molecule uses Ansible as the provisioner. The provisioner manages the life cycle of instances by communicating with the driver.</td></tr><tr><td><a href=https://ansible.readthedocs.io/projects/molecule/configuration/#scenario>Scenario</a></td><td>Molecule&rsquo;s default scenario configuration can be overridden for full control over each sequence.</td></tr><tr><td><a href=https://ansible.readthedocs.io/projects/molecule/configuration/#verifier>Verifier</a></td><td>Molecule uses Ansible as the verifier. The verifier uses the <code>verify.yml</code> playbook to check the state of the instance.</td></tr></tbody></table><p>The example below shows a basic configuration using the Docker driver to create a Debian container instance.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
<span style=color:#f92672>dependency</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>galaxy</span>
<span style=color:#f92672>driver</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>docker</span>
<span style=color:#f92672>platforms</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>instance</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>geerlingguy/docker-debian10-ansible:latest</span>
    <span style=color:#f92672>pre_build_image</span>: <span style=color:#66d9ef>true</span>
<span style=color:#f92672>provisioner</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ansible</span>
<span style=color:#f92672>verifier</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ansible</span>
</code></pre></div><h3 id=molecule-commands->Molecule Commands üìú<a hidden class=anchor aria-hidden=true href=#molecule-commands->#</a></h3><p>Molecule has several commands for performing different actions. The most common commands are:</p><table><thead><tr><th>Molecule Command</th><th>Description</th></tr></thead><tbody><tr><td><code>create</code></td><td>Creates the instance defined in the <code>molecule.yml</code> file.</td></tr><tr><td><code>destroy</code></td><td>Destroys the instance defined in the <code>molecule.yml</code> file.</td></tr><tr><td><code>login</code></td><td>Spawns a shell inside the instance. Useful for troubleshooting.</td></tr><tr><td><code>converge</code></td><td>Performs the converge sequence which includes creating the instance and executing the <code>prepare.yml</code> and <code>converge.yml</code> playbooks.</td></tr><tr><td><code>test</code></td><td>Performs a full test scenario. This includes the converge and idempotency sequences, executing the <code>verify.yml</code> playbook and destroying the instance.</td></tr></tbody></table><p>Now that we have covered the basics, let&rsquo;s test an Ansible playbook with Molecule! üß™</p><h2 id=demo->Demo üì∫<a hidden class=anchor aria-hidden=true href=#demo->#</a></h2><p>I&rsquo;ve created a <a href=https://github.com/dbrennand/molecule-demo>demo repository</a> which contains a simple playbook to install <code>nginx</code> on a Debian container instance. You&rsquo;ll need to have Docker and Python installed to use the repository.</p><p>Begin by cloning the repository:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git clone https://github.com/dbrennand/molecule-demo.git <span style=color:#f92672>&amp;&amp;</span> cd molecule-demo
</code></pre></div><p>Inspect the files and notice the <code>default</code> molecule scenario with the playbooks and <code>molecule.yml</code> configuration file. The <code>converge.yml</code> playbook calls the main <code>playbook.yml</code> two directories above.</p><p>Next, install Molecule and the Docker driver. I recommend using a virtual environment:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir -pv ~/.virtualenvs
python3 -m venv ~/.virtualenvs/molecule-demo
source ~/.virtualenvs/molecule-demo/bin/activate
pip install -r requirements.txt
</code></pre></div><p>Now we can run the <code>molecule test</code> command to perform a full test scenario:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>molecule test
</code></pre></div><p>The output should look similar to the following:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>INFO     Running default &gt; create

PLAY [Create] ******************************************************************

TASK [Create molecule instance(s)] *********************************************
changed: [localhost] =&gt; (item=instance)

...

INFO     Running default &gt; prepare

PLAY [Prepare] *****************************************************************

TASK [Gathering Facts] *********************************************************
ok: [instance]

TASK [Update apt cache] ********************************************************
changed: [instance]

...

INFO     Running default &gt; converge

PLAY [Converge] ****************************************************************

TASK [Gathering Facts] *********************************************************
ok: [instance]

PLAY [Playbook | Install nginx] ************************************************

TASK [Gathering Facts] *********************************************************
ok: [instance]

TASK [Install nginx] ***********************************************************
changed: [instance]

PLAY RECAP *********************************************************************
instance                   : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Running default &gt; idempotence

PLAY [Converge] ****************************************************************

TASK [Gathering Facts] *********************************************************
ok: [instance]

PLAY [Playbook | Install nginx] ************************************************

TASK [Gathering Facts] *********************************************************
ok: [instance]

TASK [Install nginx] ***********************************************************
ok: [instance]

PLAY RECAP *********************************************************************
instance                   : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Idempotence completed successfully.
INFO     Running default &gt; side_effect
WARNING  Skipping, side effect playbook not configured.
INFO     Running default &gt; verify
INFO     Running Ansible Verifier

PLAY [Verify] ******************************************************************

TASK [Gathering Facts] *********************************************************
ok: [instance]

TASK [Gather package list] *****************************************************
ok: [instance]

TASK [Verify nginx is installed] ***********************************************
ok: [instance] =&gt; {
    &#34;changed&#34;: false,
    &#34;msg&#34;: &#34;All assertions passed&#34;
}

PLAY RECAP *********************************************************************
instance                   : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Verifier completed successfully.
INFO     Running default &gt; cleanup
WARNING  Skipping, cleanup playbook not configured.
INFO     Running default &gt; destroy

PLAY [Destroy] *****************************************************************

TASK [Wait for instance(s) deletion to complete] *******************************
FAILED - RETRYING: [localhost]: Wait for instance(s) deletion to complete (300 retries left).
changed: [localhost] =&gt; (item=instance)

PLAY RECAP *********************************************************************
localhost                  : ok=3    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
</code></pre></div><p>Tada! You&rsquo;ve just tested an Ansible playbook with Molecule! ‚ú®üéâ</p><p>We now have peace of mind that our playbook works as expected! üôÇ</p><h2 id=conclusion->Conclusion üìù<a hidden class=anchor aria-hidden=true href=#conclusion->#</a></h2><p>In this blog post, we covered the basics of using Molecule and how to test Ansible content. I recommend checking out the <a href=https://ansible.readthedocs.io/projects/molecule/>Molecule documentation</a> for more information.</p><p>I hope you found this post useful and if you have any questions or feedback, feel free to reach out to me on <a href=https://twitter.com/dbrenuk>Twitter</a> or via <a href=mailto:contact@danielbrennand.com>email</a>.</p><p>Until next time, happy testing! üß™ üëã</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://github.com/ansible-community/molecule>https://github.com/ansible-community/molecule</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://ansible.readthedocs.io/projects/molecule/getting-started/#the-scenario-layout>https://ansible.readthedocs.io/projects/molecule/getting-started/#the-scenario-layout</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><footer class=post-footer><ul class=post-tags><li><a href=https://danielbrennand.com/tags/ansible/>Ansible</a></li><li><a href=https://danielbrennand.com/tags/testing/>Testing</a></li><li><a href=https://danielbrennand.com/tags/molecule/>Molecule</a></li></ul><nav class=paginav><a class=prev href=https://danielbrennand.com/blog/build-and-publish-container-image-gha/><span class=title>¬´ Prev</span><br><span>Build and Publish Container Images using GitHub Actions</span></a>
<a class=next href=https://danielbrennand.com/blog/managing-secrets-in-ansible/><span class=title>Next ¬ª</span><br><span>Managing Secrets in Ansible</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Testing Ansible Content with Molecule on twitter" href="https://twitter.com/intent/tweet/?text=Testing%20Ansible%20Content%20with%20Molecule&url=https%3a%2f%2fdanielbrennand.com%2fblog%2ftesting-ansible-content%2f&hashtags=Ansible%2cTesting%2cMolecule"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing Ansible Content with Molecule on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fdanielbrennand.com%2fblog%2ftesting-ansible-content%2f&title=Testing%20Ansible%20Content%20with%20Molecule&summary=Testing%20Ansible%20Content%20with%20Molecule&source=https%3a%2f%2fdanielbrennand.com%2fblog%2ftesting-ansible-content%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing Ansible Content with Molecule on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdanielbrennand.com%2fblog%2ftesting-ansible-content%2f&title=Testing%20Ansible%20Content%20with%20Molecule"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing Ansible Content with Molecule on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fdanielbrennand.com%2fblog%2ftesting-ansible-content%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing Ansible Content with Molecule on whatsapp" href="https://api.whatsapp.com/send?text=Testing%20Ansible%20Content%20with%20Molecule%20-%20https%3a%2f%2fdanielbrennand.com%2fblog%2ftesting-ansible-content%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing Ansible Content with Molecule on telegram" href="https://telegram.me/share/url?text=Testing%20Ansible%20Content%20with%20Molecule&url=https%3a%2f%2fdanielbrennand.com%2fblog%2ftesting-ansible-content%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing Ansible Content with Molecule on ycombinator" href="https://news.ycombinator.com/submitlink?t=Testing%20Ansible%20Content%20with%20Molecule&u=https%3a%2f%2fdanielbrennand.com%2fblog%2ftesting-ansible-content%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://danielbrennand.com>Daniel Brennand</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>